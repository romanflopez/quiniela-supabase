name: Quiniela Scraper Autom√°tico

on:
  schedule:
    # Ejecutar 1 minuto ANTES de cada sorteo (UTC, Argentina UTC-3)
    # El scraper esperar√° 55s y empezar√° a scrapear 5s antes del sorteo
    # La Previa: sale 10:15 ‚Üí ejecuta 10:14 Argentina = 13:14 UTC
    - cron: '14 13 * * *'
    # Primera: sale 12:00 ‚Üí ejecuta 11:59 Argentina = 14:59 UTC
    - cron: '59 14 * * *'
    # Matutina: sale 15:00 ‚Üí ejecuta 14:59 Argentina = 17:59 UTC
    - cron: '59 17 * * *'
    # Vespertina: sale 18:00 ‚Üí ejecuta 17:59 Argentina = 20:59 UTC
    - cron: '59 20 * * *'
    # Nocturna: sale 21:00 ‚Üí ejecuta 20:59 Argentina = 23:59 UTC
    - cron: '59 23 * * *'
  
  # Permitir ejecuci√≥n manual desde GitHub Actions
  workflow_dispatch:

jobs:
  scrape:
    runs-on: ubuntu-latest
    name: Ejecutar Scraper de Quiniela
    
    steps:
      - name: Esperar hasta 5s antes del sorteo
        run: sleep 55
        
      - name: Ejecutar Scraper (5s antes del sorteo)
        run: |
          echo "üé∞ Ejecutando scraper (modo lud√≥pata - retry agresivo)..."
          response=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            'https://vvtujkedjalepkhbycpv.supabase.co/functions/v1/quiniela-scraper')
          
          echo "üìä Respuesta:"
          echo "$response" | jq '.'
          
          if echo "$response" | jq -e '.success == true' > /dev/null; then
            echo "‚úÖ Scraper completado"
            exit 0
          else
            echo "‚ö†Ô∏è Algunos sorteos pueden no estar disponibles a√∫n"
            exit 0
          fi

      - name: Notificar resultado
        if: always()
        run: |
          if [ $? -eq 0 ]; then
            echo "‚úÖ Datos de Quiniela actualizados correctamente"
          else
            echo "‚ö†Ô∏è Hubo un problema al actualizar los datos"
          fi

